{{- $sitemapDomain := getenv "SITEMAP_DOMAIN" | default "ocw.mit.edu" -}}
{{- $studioBaseUrl := getenv "OCW_STUDIO_BASE_URL" -}}
{{- $apiBearerToken := getenv "API_BEARER_TOKEN" | default "" -}}
{{- $queryString := querify "version" "live" -}}
{{ printf "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\"?>" | safeHTML }}
<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  <sitemap>
    <loc>https://{{ $sitemapDomain }}/sitemap.xml</loc>
  </sitemap>
{{- if and $studioBaseUrl (ne $apiBearerToken "") -}}
  {{- $apiUrl := printf "%v/api/publish?%v" (strings.TrimSuffix "/" $studioBaseUrl) $queryString -}}
  {{- $apiHeaders := dict "headers" (dict "Authorization" (printf "Bearer %v" $apiBearerToken)) -}}
  {{- $coursesJson := resources.GetRemote $apiUrl $apiHeaders -}}
  {{- with transform.Unmarshal $coursesJson -}}
    {{- $sites := .sites -}}
    {{- if $sites -}}
      {{ range $index, $courseItem := $sites }}
        {{- $url :=  printf "https://%v/%v/sitemap.xml" $sitemapDomain (strings.TrimPrefix "/" (strings.TrimSuffix "/" $courseItem.base_url)) -}}
  <sitemap>
    <loc>{{ $url }}</loc>
  </sitemap>
      {{ end }}
    {{- end -}}
  {{- end -}}
{{- end -}}
</sitemapindex>