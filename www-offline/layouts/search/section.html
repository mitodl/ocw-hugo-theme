{{ define "main" }}
{{ $pathToRoot := strings.TrimSuffix "/" (partial "path_to_root.html" .Permalink) }}
{{ $websites := where site.Pages ".Params.content_type" "==" "website" }}
{{ block "header" . }}
{{ partial "header" . }}
{{ end }}
<div class="search-wrapper">
  <div class="search-page row justify-content-center">
    <div class="search-results-area col-12 py-4">
      <div class="container-fluid">
        <main>
          <div class="container-fluid p-0">
            <div class="row m-0">
              <div id="search-page" class="w-100">
                <div class="container">
                  <div class="search-box py-sm-5 py-md-7 py-lg-5 row">
                    <div class="col-lg-3"></div>
                    <div class="col-lg-6 search-box-inner d-flex flex-column align-items-center mb-2 mb-sm-5 mb-md-4">
                      <h1>Explore OpenCourseWare</h1>
                      <div class="w-100 d-flex flex-column align-items-center search-input-wrapper mt-5">
                        <div class="w-100">
                          <form role="search" class="search-box d-flex flex-direction-row">
                            <input
                              id="search-input"
                              class="w-100 pl-2"
                              type="text"
                              aria-label="Search"
                              placeholder="Search OpenCourseWare"
                              />
                            <button id="search-button" type="submit" class="py-2 px-3">Search</button>
                          </form>
                        </div>
                      </div>
                    </div>                
                    <div class="col-lg-3"></div>
                  </div>
                </div>
                <section id="search-results" class="m-auto px-8">
                </section>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>
</div>
<script>
window.onload = function() {
  if (window.Fuse) {
    // define the search-result web component and add it for use
    const searchResultTemplate = document.createElement("template")
    searchResultTemplate.innerHTML = `
    <article>
      <div class="card learning-resource-card compact-view">
        <div class="card-contents">
          <div class="lr-info search-result">
            <div class="col-2 course-num">
            </div>
            <div class="course-title">
              <a class="course-link"></a>
            </div>
            <div class="col-2 resource-level">
            </div>
          </div>
        </div>
      </div>
    </article>
    `

    class SearchResult extends HTMLElement {
      constructor() {
        super()
      }

      connectedCallback() {
        this.innerHTML = searchResultTemplate.innerHTML
        this.courseNumberDiv = this.querySelector(".course-num")
        this.courseLink = this.querySelector(".course-link")
        this.levelDiv = this.querySelector(".resource-level")
        this.courseNumberDiv.innerHTML = this.primaryCourseNumber
        this.courseLink.setAttribute("href", this.url)
        this.courseLink.innerHTML = this.title
        this.levelDiv.innerHTML = this.level
      }

      get title() {
        return this.getAttribute("data-title")
      }

      get primaryCourseNumber() {
        return this.getAttribute("data-primary-course-number")
      }

      get level() {
        return this.getAttribute("data-level")
      }

      get url() {
        return this.getAttribute("data-url")
      }
    }

    window.customElements.define("search-result", SearchResult)

    // an array of known websites generated at build time
    const websites = [
      {{ $websites := where site.Pages ".Params.content_type" "==" "website" }}
      {{ range $websites }}
      {{ $urlPath := strings.TrimPrefix "/" .Params.url_path }}
      {{ $url := printf "%s/%s/index.html" $pathToRoot $urlPath }}
      {
        "title": {{- .Title | jsonify -}},
        "primary_course_number": {{- .Params.primary_course_number | jsonify -}},
        "url": {{- $url -}},
        {{ if .Params.level }}
        "level": {{ (delimit .Params.level ", ") | jsonify }}
        {{ else }}
        "level": ""
        {{ end }}
      },
      {{ end }}
    ]

    // initialize Fuse and bind event listeners
    const Fuse = window.Fuse
    const searchOptions = {
      shouldSort: true,
      threshold: 0.4,
      location: 0,
      distance: 100,
      matchAllTokens: true,
      includeScore: true,
      maxPatternLength: 32,
      minMatchCharLength: 5,
      keys: ["title", "primary_course_number"]
    }
    const fuse = new Fuse(websites, searchOptions)
    const searchInput = document.getElementById("search-input")
    const searchButton = document.getElementById("search-button")
    const performSearch = searchString => {
      const searchResults = fuse.search(searchString)
      const searchResultComponents = searchResults.map(searchResult => {
        return `<search-result data-url="${searchResult.item["url"]}" data-title=${searchResult.item["title"]} data-primary-course-number=${searchResult.item["primary_course_number"]} data-level=${searchResult.item["level"]}></search-result>`
      })
      const searchResultsSection = document.getElementById("search-results")
      searchResultsSection.innerHTML = searchResultComponents.join("")
    }
    const onInput = e => {
      if (e.target.value) {
        const searchString = e.target.value
        performSearch(searchString)
      }
    }
    const onSearchButtonClick = e => {
      e.preventDefault()
      performSearch(searchInput.value)
    }
    
    searchInput.addEventListener("input", onInput)
    searchButton.addEventListener("click", onSearchButtonClick)
  }
}
</script>
{{ end }}
